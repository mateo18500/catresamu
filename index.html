<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affichage â€” SAMU Cher v2.7</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    :root{--bg:#08101e;--text:#e7eefc;--acc:#3aa1ff}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI}
    #app{display:grid;grid-template-rows:auto 1fr;height:100%}

    .topbar{position:relative;z-index:2000;display:flex;gap:.4rem;align-items:center;padding:.55rem .8rem;background:rgba(12,18,34,.9);border-bottom:1px solid #1b2947;flex-wrap:wrap}
    .chip{border:1px solid #27406f;background:#132240;color:#d8e6ff;padding:.35rem .8rem;border-radius:999px;font-size:.9rem;cursor:pointer;display:inline-flex;gap:.45rem;align-items:center}
    .chip.active{background:var(--acc);color:#001733;border-color:var(--acc)}
    .title{font-weight:700;margin-right:.4rem}
    .spacer{flex:1}
    #map{height:100%;width:100%}

    .legend{position:absolute;bottom:14px;left:14px;background:#0e1a31;border:1px solid #27406f;border-radius:12px;padding:.55rem .8rem;color:#cfe3ff;z-index:100}

    .search{position:relative;display:flex;align-items:center;gap:.4rem;border:1px solid #27406f;background:#0f1c36;border-radius:999px;padding:.2rem .6rem}
    .search input{background:transparent;border:none;outline:none;color:#e7eefc;min-width:240px}

    .suggest{
      position:absolute;top:40px;left:0;right:0;
      background:#0e1a31;color:#e7eefc;border:1px solid #27406f;border-radius:10px;
      max-height:260px;overflow:auto;z-index:3000;display:none;
      box-shadow:0 8px 20px rgba(0,0,0,.35)
    }
    .suggest div{padding:.45rem .6rem;cursor:pointer}
    .suggest div:hover{background:#152446}
  </style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="title">Affichage â€” SAMU Cher v2.7</div>
    <button id="btnAmb" class="chip">Ambulance</button>
    <button id="btnSmur" class="chip">SMUR</button>
    <button id="btnMob" class="chip">MÃ©decin mobile</button>
    <div class="spacer"></div>
    <div class="search">
      <span>ðŸ”Ž</span>
      <input id="q" placeholder="Rechercher une commune (accents ignorÃ©s)â€¦" />
      <div id="suggest" class="suggest"></div>
    </div>
    <button id="toggleHop" class="chip">HÃ´pitaux</button>
    <button id="toggleCli" class="chip">Cliniques</button>
    <button id="toggleHel" class="chip">HÃ©lipads</button>
    <button id="togglePou" class="chip">POUI</button>
  </div>

  <div style="position:relative">
    <div id="map"></div>
    <div class="legend">Limite Cher <span style="display:inline-block;width:12px;height:12px;background:#ff5a5f;border-radius:50%;margin-left:.35rem"></span></div>
  </div>
</div>

<script>
// ===== ClÃ©s locales (uniquement pour contour & communes)
const KEY = { communes:'samuCherCommunes', cher:'samuCherBoundary' };
const load=(k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? f }catch{ return f } };

// ===== Carte
const map=L.map('map',{preferCanvas:true,zoomControl:true}).setView([47.08,2.40],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:35,attribution:'Â© OpenStreetMap'}).addTo(map);

const baseStyle={ color:'#36558f', weight:1, fillColor:'#1d2b4b', fillOpacity:.35 };

const cherData=load(KEY.cher,null);
if(cherData) L.geoJSON(cherData,{style:{color:'#ff5a5f',weight:3,fill:false,dashArray:'6,8'}}).addTo(map);

const communes=load(KEY.communes,{type:'FeatureCollection',features:[]});
const communesLayer=L.geoJSON(communes,{style:baseStyle,onEachFeature:(f,ly)=>ly.bindTooltip(f.properties.nom)}).addTo(map);
try{
  const b = communesLayer.getBounds().pad(0.2);
  map.fitBounds(b);
  // aprÃ¨s le recadrage, on zoome lÃ©gÃ¨rement (1 cran) :
  map.once('moveend', () => map.setZoom(map.getZoom() + 4));
}catch{}

// ===== POI (icÃ´nes)
const poiLayers={ hopital:L.layerGroup().addTo(map), clinique:L.layerGroup().addTo(map), helipad:L.layerGroup().addTo(map), poui:L.layerGroup().addTo(map) };
const icons={
  hopital: L.icon({iconUrl:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTA3NI9TEwWYyzyFhYfCxCoiC1KSJS_Zef6Ww&s',iconRetinaUrl:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTA3NI9TEwWYyzyFhYfCxCoiC1KSJS_Zef6Ww&s',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-12]}),
  clinique: L.icon({iconUrl:'icons/clinique.png',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-12]}),
  helipad: L.icon({iconUrl:'https://e7.pngegg.com/pngimages/490/528/png-clipart-military-helicopter-landing-zone-helipad-signboard-miscellaneous-text-thumbnail.png',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-12]}),
  poui: L.icon({iconUrl:'https://pixabay.com/gifs/get/g198a0d6d23cb2d1b3ff6b78d00732fdacf196593d459d828e71d71f2acf91e7626de0de0a0a20fb4b8f9464c224a7513454ad0faf8c058ccd51b384bd0ae52743333ad4cc659650f763582e7a9069428_128.gif',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-12]})
};
function iconFor(type){ return icons[type] || L.icon({iconUrl:'icons/default.png',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-12]}); }

// Tableau global alimentÃ© par Firebase :
let pois = [];
function renderPOI(){
  Object.values(poiLayers).forEach(l=>l.clearLayers());
  (pois||[]).forEach(p=> L.marker([p.lat,p.lng],{icon:iconFor(p.type)}).bindPopup(`<b>${p.name}</b><br>${p.type}`).addTo(poiLayers[p.type]));
}

// ===== Services & groupes
let services={
  'Ambulance':{groups:{'Nord':[],'Est':[],'St Amand':[],'Bourges':[],'Vierzon':[]},colors:{'Nord':'#22c55e','Est':'#3b82f6','St Amand':'#f59e0b','Bourges':'#ef4444','Vierzon':'#a855f7'}},
  'SMUR':{groups:{'Bourges':[],'Vierzon':[],'St Amand':[],'Cosne':[],'Nevers':[],'Gien':[]},colors:{'Bourges':'#ef4444','Vierzon':'#f59e0b','St Amand':'#22c55e','Cosne':'#3b82f6','Nevers':'#a855f7','Gien':'#14b8a6'}},
  'MÃ©decin mobile':{groups:{'Nord':[],'Sud':[]},colors:{'Nord':'#22c55e','Sud':'#ef4444'}}
};

const svcLayers={Ambulance:L.layerGroup(),SMUR:L.layerGroup(),"MÃ©decin mobile":L.layerGroup()};
function renderService(svc){
  svcLayers[svc].clearLayers();
  const gj=communes; // dÃ©jÃ  chargÃ©
  Object.entries(services[svc].groups).forEach(([g,codes])=>{
    if(!codes?.length) return;
    const feats=gj.features.filter(f=>codes.includes(f.properties.code));
    if(!feats.length) return;
    let u=feats[0]; for(let i=1;i<feats.length;i++) u=turf.union(u,feats[i]);
    const col=services[svc].colors[g]||'#3aa1ff';
    L.geoJSON(u,{style:{color:col,weight:2,fillColor:col,fillOpacity:.22}}).bindTooltip(`${svc} â€” ${g}`).addTo(svcLayers[svc]);
  });
}
function toggleService(svc,btn){
  const on=map.hasLayer(svcLayers[svc]);
  if(on){ map.removeLayer(svcLayers[svc]); btn.classList.remove('active'); }
  else { renderService(svc); svcLayers[svc].addTo(map); btn.classList.add('active'); }
}
document.getElementById('btnAmb').onclick=()=> toggleService('Ambulance',document.getElementById('btnAmb'));
document.getElementById('btnSmur').onclick=()=> toggleService('SMUR',document.getElementById('btnSmur'));
document.getElementById('btnMob').onclick=()=> toggleService('MÃ©decin mobile',document.getElementById('btnMob'));

// POI toggles
function toggle(layer){ if(map.hasLayer(layer)) map.removeLayer(layer); else layer.addTo(map); }
document.getElementById('toggleHop').onclick=()=>toggle(poiLayers.hopital);
document.getElementById('toggleCli').onclick=()=>toggle(poiLayers.clinique);
document.getElementById('toggleHel').onclick=()=>toggle(poiLayers.helipad);
document.getElementById('togglePou').onclick=()=>toggle(poiLayers.poui);

// ===== Recherche avec suggestions
const input=document.getElementById('q');
const suggestBox=document.getElementById('suggest');
const normalize=(s)=>{try{return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}catch{return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();}};
function buildIndexFromMap(){ const arr=[]; communesLayer.eachLayer(ly=>{const f=ly.feature; arr.push({code:f.properties.code,nom:f.properties.nom,nom_norm:normalize(f.properties.nom||''),layer:ly});}); return arr;}
let featsIndex=[]; setTimeout(()=>{featsIndex=buildIndexFromMap();},0);
function showSuggest(items){ if(!items.length){suggestBox.style.display='none';suggestBox.innerHTML='';return;} suggestBox.innerHTML=''; items.slice(0,40).forEach(it=>{ const d=document.createElement('div'); d.textContent=`${it.nom} (${it.code})`; d.onclick=()=> zoomTo(it.layer); suggestBox.appendChild(d); }); suggestBox.style.display='block'; }
function zoomTo(layer){ suggestBox.style.display='none'; if(!layer) return; map.fitBounds(layer.getBounds().pad(0.5)); const old={color:layer.options.color,weight:layer.options.weight,fillColor:layer.options.fillColor,fillOpacity:layer.options.fillOpacity}; const flash={color:'#ffffff',weight:4,fillColor:'#ffffff88',fillOpacity:.6}; layer.setStyle(flash); setTimeout(()=>layer.setStyle(old),600); setTimeout(()=>layer.setStyle(flash),1100); setTimeout(()=>layer.setStyle(old),1700); }
input.addEventListener('input',()=>{ const q=normalize(input.value||''); if(!q){ showSuggest([]); return; } const res=featsIndex.filter(f=> f.nom_norm.includes(q) || (f.code||'').includes(q) ); showSuggest(res); });
input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const q=normalize(input.value||''); const res=featsIndex.filter(f=> f.nom_norm.includes(q) || (f.code||'').includes(q) ); if(res[0]) zoomTo(res[0].layer); }});
document.addEventListener('click',(e)=>{ if(!suggestBox.contains(e.target) && e.target!==input){ suggestBox.style.display='none'; }});
</script>

<!-- ===== CONNECTEUR FIREBASE (LECTURE TEMPS RÃ‰EL) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA-qJXZInw_RGfHL86JSe94Q3sjcoybpVI",
    authDomain: "samu-cher-map.firebaseapp.com",
    databaseURL: "https://samu-cher-map-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "samu-cher-map",
    storageBucket: "samu-cher-map.firebasestorage.app",
    messagingSenderId: "992546090147",
    appId: "1:992546090147:web:c84cc2e9459017b8ba2316"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // POI en temps rÃ©el
  onValue(ref(db, "pois"), (snap) => {
    if (!snap.exists()) { pois = []; renderPOI(); return; }
    const v = snap.val();
    pois = Array.isArray(v) ? v : Object.values(v);
    renderPOI();
  });

  // Services en temps rÃ©el
  onValue(ref(db, "services"), (snap) => {
    if (!snap.exists()) return;
    services = snap.val(); // remplace l'objet global

    // Si un service est actuellement affichÃ©, on le rÃ©actualise
    ["Ambulance","SMUR","MÃ©decin mobile"].forEach(s=>{
      if (map.hasLayer(svcLayers[s])) { renderService(s); }
    });
  });
</script>

</body>
</html>
